<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test HR Dashboard API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .stat-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 8px;
            display: inline-block;
            min-width: 150px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        .stat-title {
            color: #666;
            margin-bottom: 8px;
        }
        .error {
            color: red;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            background: #e6ffe6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>HR Dashboard API Test</h1>
    
    <div>
        <button onclick="testLogin()">1. Test Login</button>
        <button onclick="testDashboardStats()">2. Test Dashboard Stats</button>
        <button onclick="testFullFlow()">3. Test Full Flow</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div id="status"></div>
    
    <div id="stats-display">
        <h2>KPI Values:</h2>
        <div id="kpi-cards"></div>
    </div>
    
    <div id="logs"></div>

    <script>
        let authToken = null;
        
        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.textContent += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logs').textContent = '';
        }
        
        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
        }
        
        function displayKPIs(stats) {
            const kpiCards = document.getElementById('kpi-cards');
            
            const kpis = [
                { title: 'Properties', value: stats.totalProperties },
                { title: 'Managers', value: stats.totalManagers },
                { title: 'Employees', value: stats.totalEmployees },
                { title: 'Pending Applications', value: stats.pendingApplications }
            ];
            
            kpiCards.innerHTML = kpis.map(kpi => `
                <div class="stat-card">
                    <div class="stat-title">${kpi.title}</div>
                    <div class="stat-value">${kpi.value}</div>
                </div>
            `).join('');
        }
        
        async function testLogin() {
            log('üîç Testing login...');
            
            try {
                const response = await fetch('http://127.0.0.1:8000/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'hr@hoteltest.com',
                        password: 'admin123'
                    })
                });
                
                log(`Login response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Login response: ${JSON.stringify(data, null, 2)}`);
                    
                    // Extract token like the frontend does
                    authToken = data.data?.token || data.token;
                    
                    if (authToken) {
                        log(`‚úÖ Login successful, token: ${authToken.substring(0, 20)}...`);
                        showStatus('Login successful!');
                        return true;
                    } else {
                        log('‚ùå No token in login response');
                        showStatus('Login failed: No token received', true);
                        return false;
                    }
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Login failed: ${errorText}`);
                    showStatus(`Login failed: ${response.status}`, true);
                    return false;
                }
            } catch (error) {
                log(`‚ùå Login error: ${error.message}`);
                showStatus(`Login error: ${error.message}`, true);
                return false;
            }
        }
        
        async function testDashboardStats() {
            if (!authToken) {
                log('‚ùå No auth token, please login first');
                showStatus('Please login first', true);
                return;
            }
            
            log('üîç Testing dashboard stats...');
            
            try {
                const response = await fetch('http://127.0.0.1:8000/hr/dashboard-stats', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`Dashboard stats response status: ${response.status}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Dashboard stats response: ${JSON.stringify(data, null, 2)}`);
                    
                    // Extract data like the frontend does
                    const statsData = data.data || data;
                    log(`Extracted stats data: ${JSON.stringify(statsData, null, 2)}`);
                    
                    // Display the KPIs
                    displayKPIs(statsData);
                    
                    showStatus('Dashboard stats loaded successfully!');
                    
                    // Check for zero values
                    const zeroValues = Object.entries(statsData).filter(([key, value]) => value === 0);
                    if (zeroValues.length > 0) {
                        log(`‚ö†Ô∏è Zero values found: ${zeroValues.map(([key]) => key).join(', ')}`);
                    }
                    
                    return statsData;
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Dashboard stats failed: ${errorText}`);
                    showStatus(`Dashboard stats failed: ${response.status}`, true);
                    return null;
                }
            } catch (error) {
                log(`‚ùå Dashboard stats error: ${error.message}`);
                showStatus(`Dashboard stats error: ${error.message}`, true);
                return null;
            }
        }
        
        async function testFullFlow() {
            log('üöÄ Testing full flow...');
            clearLogs();
            
            const loginSuccess = await testLogin();
            if (loginSuccess) {
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
                await testDashboardStats();
            }
        }
        
        // Auto-run the test when page loads
        window.addEventListener('load', () => {
            log('üåê Page loaded, ready to test');
            log('Click "Test Full Flow" to simulate the frontend behavior');
        });
    </script>
</body>
</html>